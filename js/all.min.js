var map,infowindow,locations=[],initApp=function(){function e(e,t,o,r,n,i,a){var l=this;l.title=e,l.latitude=o,l.content=t,l.longitude=r,l.categories=n,l.imgURL="",l.venueID=i,l.venueIndex=a}function t(){var e=this;map=new google.maps.Map(document.getElementById("map"),{center:{lat:40.835105,lng:-73.945388},zoom:14}),infowindow=new google.maps.InfoWindow,map.set("styles",a),e.locations=ko.observableArray(locations),e.currentFilter=ko.observable(),e.searchFilter=ko.observable(),e.categoryFilter=ko.observable(),e.setFilter=function(t,o){e.currentFilter(t)},e.setMarkers=ko.computed(function(){ko.utils.arrayForEach(this.locations(),function(e){e.marker||(e.marker=new google.maps.Marker({position:{lat:Number(e.latitude),lng:Number(e.longitude)},map:map,title:e.title,animation:google.maps.Animation.DROP}),e.marker.setMap(null),e.clickFunc(),o(e.venueIndex,e.venueID))})},e),e.filteredMarkers=function(){if("search"==e.currentFilter()){if(e.searchFilter()){var t=e.searchFilter(),o=new RegExp(t,"ig");return ko.utils.arrayFilter(e.locations(),function(e){return e.marker.title.match(o)?(e.marker.setMap(map),!0):void e.marker.setMap(null)})}return ko.utils.arrayForEach(e.locations(),function(e){e.marker.setMap(map)}),e.locations()}},e.filter=function(t){console.log("Running filter"),e.setFilter("category"),e.categoryFilter(t)},e.activateMarker=function(e,t){console.log("event",t),console.log("data",e.marker),e.showInfoPanel()}}function o(e,t){$.ajax({url:c(t),data:"",dataType:"json",success:function(t){t.response.photos.items.length&&(venuePhotoPrefix=t.response.photos.items[0].prefix,venuePhotoSuffix=t.response.photos.items[0].suffix,venuePhotoURL=venuePhotoPrefix+"200x200"+venuePhotoSuffix,console.log(e),console.log(extraCreditViewModel.locations()),extraCreditViewModel.locations()[e].imgURL=venuePhotoURL,console.log(venuePhotoURL))},error:{message:"Access denied",__type:"Authorization Error"}})}var r={},n="../images/map-icons/",i={artgallery:{iconType:"Art Gallery/Museum",icon:n+"artgallery.png"},library:{iconType:"Library",icon:n+"library.png"},afterSchoolProgram:{iconType:"Extra Credit",icon:n+"school.png"}},a=[{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"poi.school",icon:n+i.library.icon,stylers:[{visibility:"on"}]},{featureType:"poi.school",elementType:"geometry.fill",stylers:[{color:"#A1A0D8"}]},{featureType:"poi.school",elementType:"labels.text.fill",stylers:[{color:"#A9CCE6"}]},{featureType:"poi.school",elementType:"labels.text.stroke",stylers:[{color:"#2B2D2A"},{weight:3}]},{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#E3E4EF"}]},{featureType:"administrative",elementType:"labels.text.stroke",stylers:[{color:"#2B2D2A"},{weight:2}]},{featureType:"landscape",elementType:"geometry.fill",stylers:[{color:"#393F42"}]},{featureType:"landscape.man_made",elementType:"geometry.stroke",stylers:[{color:"#E5DAB3"}]},{featureType:"water",stylers:[{color:"#7C9CC5"}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#4D565E"}]},{featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#CAA958"}]},{featureType:"road",elementType:"labels.text.stroke",stylers:[{color:"#2B2D2A"},{weight:2}]},{featureType:"road.highway",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"geometry.fill",stylers:[{color:"#595B5C"}]},{featureType:"poi.park"}];e.prototype.clickFunc=function(){var e=this;e.marker.addListener("click",function(){e.showInfoPanel()})},e.prototype.showInfoPanel=function(){var e=this,t="";null!==e.marker.getAnimation()?e.marker.setAnimation(null):(e.marker.setAnimation(google.maps.Animation.BOUNCE),window.setTimeout(function(){e.marker.setAnimation(null),window.setTimeout(function(){t='<div class="info-window-content">',t+="<h2>"+e.title+"</h2>",e.imgURL&&(t+='<img src="'+e.imgURL+'" />'),t+="</div>",infowindow.setContent(t),infowindow.open(map,e.marker),e.marker.setAnimation(null)},200)},600))},extraCreditViewModel=new t;var l=function(){var e,t,o,r=document.getElementById("legend");for(var n in i)e=n.iconType,t=n.icon,o=document.createElement("div"),o.innerHTML='<img src="'+i[n].icon+'"> '+i[n].iconType,r.appendChild(o)};l();var s="https://api.foursquare.com/v2/venues/search?client_id=XV0OVKSTK15ITPVJOMDIBPZYBYEI5OOKSXD0GTH4JFKIXYWZ&client_secret=GRYWQV4WWFFVJ3VQPJX4TLMBCPXP3BFCPH4IWZGUTM4MCORP&v=20151107&ll=40.835105,-73.945388&radius=800&categoryId=4bf58dd8d48988d181941735,4bf58dd8d48988d1e2931735&intent=browse&limit=100",c=function(e){return"https://api.foursquare.com/v2/venues/"+e+"/photos?client_id=XV0OVKSTK15ITPVJOMDIBPZYBYEI5OOKSXD0GTH4JFKIXYWZ&client_secret=GRYWQV4WWFFVJ3VQPJX4TLMBCPXP3BFCPH4IWZGUTM4MCORP&v=20151107&limit=1"};r.fourSquare=function(t){$.ajax({url:s,data:"",dataType:"json",success:function(t){var o,r,n,i,a,l,s,c,u=t.response.venues.length;for(c=0;u>c;c++)r=c,o=t.response.venues[c].id,n=t.response.venues[c].name,i=t.response.venues[c].location.address,a=t.response.venues[c].location.lat,l=t.response.venues[c].location.lng,s=t.response.venues[c].categories,extraCreditViewModel.locations.push(new e(n,i,a,l,s,o,r))},error:{message:"Access denied",__type:"Authorization Error"}})},r.fourSquare(),ko.applyBindings(extraCreditViewModel)};